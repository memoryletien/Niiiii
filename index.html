<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ni Chủ Tọa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Pinyon+Script&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #0f0505;
        font-family: "Cinzel", serif;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      #background-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -3;
        background-image: url("./back.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.8;
      }

      #bg-gradient {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        background: radial-gradient(
          circle at 50% 40%,
          rgba(123, 13, 30, 0.5) 0%,
          rgba(74, 14, 22, 0.4) 50%,
          rgba(26, 5, 5, 0.6) 100%
        );
      }

      #black-void {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 5;
        opacity: 0;
        pointer-events: none;
        transition: opacity 1.5s ease;
      }

      #frost-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
        box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.7);
        background: radial-gradient(
          circle,
          transparent 60%,
          rgba(20, 0, 5, 0.3) 100%
        );
      }

      #canvas-container {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
      }

      #firework-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 6;
        pointer-events: none;
        display: none;
      }

      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 10vh;
        transition: opacity 0.5s;
      }

      #main-title {
        font-family: "Pinyon Script", cursive;
        font-size: 15vw;
        color: #eebb66;
        margin: 0;
        text-shadow: 0 2px 5px rgba(255, 215, 0, 0.3);
        animation: floatTitle 4s ease-in-out infinite;
        background: linear-gradient(
          to bottom,
          #fceabb 0%,
          #fccd4d 50%,
          #f8b500 51%,
          #fbdf93 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        line-height: 1.2;
      }

      #mode-indicator {
        font-family: "Cinzel", serif;
        font-size: 3vw;
        font-weight: 700;
        color: #ffd700;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-top: 10px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        padding-bottom: 5px;
      }

      #secret-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: "Cinzel", serif;
        font-weight: 700;
        font-size: 8vw;
        width: 90%;
        white-space: normal;
        line-height: 1.3;
        text-transform: uppercase;
        letter-spacing: 4px;
        text-align: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        background: linear-gradient(
          to bottom,
          #fff8db 0%,
          #ffd700 40%,
          #daa520 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        transition: opacity 1.5s ease;
      }

      #lyrics-container {
        position: absolute;
        bottom: 20%;
        width: 100%;
        text-align: center;
        z-index: 20;
        pointer-events: none;
      }
      #lyrics-text {
        font-family: "Pinyon Script", cursive;
        font-size: 6vw;
        color: #fff0f5;
        text-shadow: 0 0 5px rgba(255, 200, 200, 0.5);
        padding: 0 20px;
        transition: all 0.3s ease;
      }

      #webcam-wrapper {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 100px;
        height: 75px;
        z-index: 50;
        background: #000;
        border: 1px solid #ffd700;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        overflow: hidden;
        opacity: 0.6;
      }
      #webcam-canvas {
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
        border-radius: 2px;
      }
      #cam-stats {
        display: none;
      }

      #start-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 5, 5, 0.9);
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: opacity 0.8s;
      }
      .start-btn {
        border: 1px solid #eebb66;
        padding: 15px 30px;
        color: #eebb66;
        font-size: 14px;
        font-family: "Cinzel", serif;
        letter-spacing: 4px;
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.6);
        margin-bottom: 15px;
        box-shadow: 0 0 20px rgba(238, 187, 102, 0.2);
        transition: all 0.3s;
      }
      .start-note {
        color: #886666;
        font-size: 12px;
        font-style: italic;
      }

      #touch-hint {
        position: absolute;
        bottom: 100px;
        width: 100%;
        text-align: center;
        font-size: 10px;
        color: rgba(255, 215, 0, 0.5);
        pointer-events: none;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      @keyframes floatTitle {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      @media (min-width: 768px) {
        #main-title {
          font-size: 80px;
        }
        #mode-indicator {
          font-size: 9px;
        }
        #secret-message {
          font-size: 5vw;
          width: 80%;
        }
        #lyrics-text {
          font-size: 32px;
        }
        #webcam-wrapper {
          width: 150px;
          height: 112px;
          opacity: 1;
        }
        #cam-stats {
          display: block;
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          text-align: center;
          font-family: "Cinzel", serif;
          font-size: 6px;
          font-weight: 700;
          color: #ffd700;
          letter-spacing: 2px;
          text-transform: uppercase;
          z-index: 26;
          background: rgba(0, 0, 0, 0.8);
          padding: 4px 0;
          border-top: 1px solid #ffd700;
        }
      }
    </style>
    <!-- Tối ưu: Chỉ load các script thật sự cần thiết -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  </head>
  <body>
    <div id="background-image"></div>
    <div id="black-void"></div>
    <div id="bg-gradient"></div>
    <div id="frost-overlay"></div>

    <div id="canvas-container"></div>
    <canvas id="firework-canvas"></canvas>

    <div id="secret-message">MERRY CHRISTMAS NI CHỦ TỌA</div>

    <div id="ui-layer">
      <h1 id="main-title">Ni là số 1</h1>
      <div id="mode-indicator">SAO MÀ XINH QUÁ VẬY TRỜI</div>
      <div id="touch-hint">SWIPE TO ROTATE &bull; TAP TO SWITCH</div>
    </div>
    <div id="start-overlay">
      <div class="start-btn">NHẤN NÈ NI</div>
      <div class="start-note">♫ Last Christmas</div>
    </div>
    <div id="lyrics-container"><span id="lyrics-text">...</span></div>

    <div id="webcam-wrapper">
      <div id="cam-stats">SCAN</div>
      <canvas id="webcam-canvas"></canvas>
    </div>

    <video
      id="input_video"
      style="display: none; transform: scaleX(-1)"
      playsinline
    ></video>
    <audio id="bg-music" src="./audio.mp3" loop preload="metadata"></audio>

    <script>
      // ========== TỐI ƯU HÓA CẤU HÌNH ==========
      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        ) || window.innerWidth < 800;

      // Giảm số lượng particle và texture để tăng performance
      const TOTAL_PHOTOS = isMobile ? 6 : 12; // Giảm từ 8/20 xuống 6/12
      const PARTICLE_RATIO = isMobile ? 0.2 : 0.6; // Giảm particle

      const AI_SKIP_FRAMES = isMobile ? 10 : 4; // Tăng skip frames để giảm xử lý

      const LYRICS_DATA = [
        { time: 0.0, text: "Thiên thượng thiên hạ" },
        { time: 4.0, text: "Vô nhân khả tỉ" },
        { time: 7.13, text: "Thiên thượng thiên hạ" },
        { time: 11.08, text: "Vô nhân khả tỉ" },
        { time: 15.08, text: "Thiên thượng thiên hạ" },
        { time: 18.99, text: "Vô nhân khả tỉ" },
      ];

      const zFactor = isMobile ? 1.4 : 1.0;
      const SCENE_CONFIG = {
        scaleFar: isMobile ? 6.0 : 8.0, // Giảm scale
        posFar: { x: 0.0, y: isMobile ? -0.2 : -0.6 },
        camZFar: 7.7 * zFactor,
        scaleNear: 8.0, // Giảm scale
        posNear: { x: 0.0, y: -0.7 },
        camZNear: 2.5,
        zoomSpeed: 0.1,
        rotateSpeed: 0.08,
      };

      // Giảm số lượng particle trong các layer
      const LAYERS = [
        {
          id: "inner_snow",
          shape: "Snowflake",
          count: Math.floor(800 * PARTICLE_RATIO), // Giảm từ 1200
          opacity: 0.9,
          color: "#ffffff",
          speed: 0.0005,
          size: 0.06,
          radius: 0.48,
          startY: 1.1,
          endY: -0.3,
          drift: 0.01,
          twinkle: false,
          rotateWithJar: true,
        },
        {
          id: "snow_main",
          shape: "Snowflake",
          count: Math.floor(300 * PARTICLE_RATIO), // Giảm từ 500
          opacity: 0.9,
          color: "#e0ffff",
          speed: 0.001,
          size: 0.18,
          radius: 5.0,
          startY: 7.0,
          endY: -6.0,
          drift: 0.05,
          twinkle: true,
          rotateWithJar: true,
        },
        {
          id: "gold_dust",
          shape: "Circle",
          count: Math.floor(300 * PARTICLE_RATIO), // Giảm từ 500
          opacity: 0.8,
          color: "#ffcc00",
          speed: 0.0006,
          size: 0.03,
          radius: 4.5,
          startY: 6.0,
          endY: -4.0,
          drift: 0.08,
          twinkle: true,
          rotateWithJar: true,
        },
      ];

      let scene,
        camera,
        renderer,
        carModel,
        mixer,
        particleSystems = {},
        textureCache = {},
        polaroidTextures = [],
        polaroidGroup,
        clock = new THREE.Clock(),
        bgParticleGroup;
      let isGalleryMode = false,
        lastGesture = "NONE",
        isZoomedIn = false,
        lastSwitchTime = 0,
        lastDropTime = 0,
        jarOffsetY = 0,
        inspectedPhoto = null;
      const SWITCH_COOLDOWN = 1.0;

      const STATE = {
        hand: { detected: false, x: 0.5, y: 0.5, gesture: "NONE" },
        targetRotation: { x: 0, y: 0 },
        currentRotation: { x: 0, y: 0 },
      };

      let isFireworkMode = false;

      let touchStartX = 0,
        touchStartY = 0;
      let isTouching = false;
      let touchLastTap = 0;

      const FW_CONFIG = {
        particleCount: isMobile ? 30 : 200, // Giảm particle firework
        explosionRadius: 20,
        friction: 0.98,
        gravity: 0.04,
        focalLength: 800,
        autoFireRate: isMobile ? 150 : 120, // Giảm firework rate
      };
      let fwCanvas, fwCtx, fwWidth, fwHeight, fwCx, fwCy;
      let fwParticles = [];
      let fwFireworks = [];

      // ========== HÀM KHỞI TẠO TỐI ƯU ==========
      function initFireworkCanvas() {
        fwCanvas = document.getElementById("firework-canvas");
        fwCtx = fwCanvas.getContext("2d");
        resizeFw();
        window.addEventListener("resize", resizeFw);
      }

      function resizeFw() {
        fwWidth = window.innerWidth;
        fwHeight = window.innerHeight;
        fwCanvas.width = fwWidth;
        fwCanvas.height = fwHeight;
        fwCx = fwWidth / 2;
        fwCy = fwHeight / 2;
      }

      // ========== LOADER ĐƠN GIẢN ==========
      let assetsLoaded = 0;
      const totalAssets = 2; // chỉ đếm các assets chính

      function checkAssetsLoaded() {
        assetsLoaded++;
        if (assetsLoaded >= totalAssets) {
          document.getElementById("start-overlay").style.display = "flex";
        }
      }

      // ========== KHỞI TẠO CHÍNH ==========
      function init() {
        const overlay = document.getElementById("start-overlay");
        const audio = document.getElementById("bg-music");

        overlay.addEventListener("click", () => {
          overlay.style.opacity = 0;
          setTimeout(() => overlay.remove(), 500);
          initTouchControls();
          audio.play().catch((e) => {
            console.log("Audio Error:", e);
          });
        });

        const container = document.getElementById("canvas-container");
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          45,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 0, SCENE_CONFIG.camZFar);

        // Cấu hình renderer tối ưu
        renderer = new THREE.WebGLRenderer({
          antialias: false,
          alpha: true,
          powerPreference: "high-performance",
          preserveDrawingBuffer: false,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(isMobile ? 1.0 : 1.5); // Giảm pixel ratio trên mobile
        renderer.toneMapping = THREE.NoToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.outputColorSpace = THREE.SRGBColorSpace;

        container.appendChild(renderer.domElement);

        // TẢI ASSETS BẤT ĐỒNG BỘ
        Promise.all([
          loadEssentialAssets(),
          new Promise((resolve) => {
            // Tải model sau cùng
            const loader = new THREE.GLTFLoader();
            loader.load(
              "./car.glb",
              (gltf) => {
                carModel = gltf.scene;
                carModel.scale.setScalar(SCENE_CONFIG.scaleFar);
                carModel.position.set(
                  SCENE_CONFIG.posFar.x,
                  SCENE_CONFIG.posFar.y,
                  0
                );
                carModel.position.z = -0.5;
                carModel.rotation.set(0, 0, 0);
                if (gltf.animations.length) {
                  mixer = new THREE.AnimationMixer(carModel);
                  mixer.clipAction(gltf.animations[0]).play();
                }
                scene.add(carModel);
                resolve();
              },
              undefined,
              (error) => {
                console.error("Error loading model:", error);
                resolve(); // Vẫn tiếp tục dù có lỗi
              }
            );
          }),
        ]).then(() => {
          setupSceneLighting();
          setupBackgroundParticles();
          LAYERS.forEach(createLayerSystem);
          createPolaroids();
          initFireworkCanvas();
          initHandTracking();
          animate();
        });

        window.addEventListener(
          "resize",
          () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            resizeFw();
          },
          { passive: true }
        );
      }

      // ========== TẢI ASSETS THIẾT YẾU ==========
      async function loadEssentialAssets() {
        await Promise.all([loadTextures(), loadPolaroidTextures()]);
      }

      function setupSceneLighting() {
        scene.environment = null;
        scene.background = null;

        // Ánh sáng tối ưu
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
      }

      function initTouchControls() {
        const el = document.getElementById("canvas-container");

        el.addEventListener(
          "touchstart",
          (e) => {
            if (e.touches.length === 1) {
              touchStartX = e.touches[0].clientX;
              touchStartY = e.touches[0].clientY;
              isTouching = true;
            }
          },
          { passive: true }
        );

        el.addEventListener(
          "touchmove",
          (e) => {
            if (!isTouching || isFireworkMode) return;
            if (e.touches.length === 1) {
              const x = e.touches[0].clientX;
              const y = e.touches[0].clientY;
              const dx = (x - touchStartX) * 0.005;
              const dy = (y - touchStartY) * 0.005;

              if (!isGalleryMode) {
                STATE.targetRotation.x += dy;
                STATE.targetRotation.y += dx;
                STATE.currentRotation.x = STATE.targetRotation.x;
                STATE.currentRotation.y = STATE.targetRotation.y;
                if (carModel) {
                  carModel.rotation.y = STATE.currentRotation.y;
                  carModel.rotation.x = STATE.currentRotation.x;
                }
              }
              touchStartX = x;
              touchStartY = y;
            }
          },
          { passive: true }
        );

        el.addEventListener("touchend", (e) => {
          isTouching = false;
          const now = Date.now();
          if (now - touchLastTap < 300) toggleMode();
          touchLastTap = now;
        });
      }

      // ========== TẢI TEXTURE TỐI ƯU ==========
      function loadPolaroidTextures() {
        return new Promise((resolve) => {
          let loaded = 0;
          const total = TOTAL_PHOTOS;

          for (let i = 1; i <= total; i++) {
            const canvas = document.createElement("canvas");
            canvas.width = isMobile ? 200 : 300; // Giảm kích thước canvas
            canvas.height = isMobile ? 250 : 375;
            const ctx = canvas.getContext("2d");

            const texture = new THREE.CanvasTexture(canvas);
            texture.colorSpace = THREE.SRGBColorSpace;
            polaroidTextures.push(texture);

            // Tạo placeholder trước
            ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
            ctx.font = "italic 16px Pinyon Script";
            ctx.textAlign = "center";
            ctx.fillText(
              `Loading ${i}`,
              canvas.width / 2,
              canvas.height / 2
            );

            // Tải ảnh trong background
            setTimeout(() => {
              const img = new Image();
              img.crossOrigin = "anonymous";
              img.onload = function () {
                const border = 8;
                const containerWidth = canvas.width - border * 2;
                const containerHeight = canvas.height - 60 - border;
                const imgRatio = img.width / img.height;
                const containerRatio = containerWidth / containerHeight;

                let drawWidth, drawHeight, drawX, drawY;

                if (imgRatio > containerRatio) {
                  drawWidth = containerWidth;
                  drawHeight = containerWidth / imgRatio;
                  drawX = border;
                  drawY = border + (containerHeight - drawHeight) / 2;
                } else {
                  drawHeight = containerHeight;
                  drawWidth = containerHeight * imgRatio;
                  drawX = border + (containerWidth - drawWidth) / 2;
                  drawY = border;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);

                ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                ctx.font = "italic 18px Pinyon Script";
                ctx.fillText(
                  `Moment ${i}`,
                  canvas.width / 2,
                  canvas.height - 20
                );

                texture.needsUpdate = true;
                loaded++;
                if (loaded === total) resolve();
              };
              img.onerror = () => {
                loaded++;
                if (loaded === total) resolve();
              };
              img.src = `./images/${i}.png?v=${Date.now()}`;
            }, i * 100); // Stagger loading
          }
        });
      }

      function loadTextures() {
        return new Promise((resolve) => {
          const textureLoader = new THREE.TextureLoader();
          
          // Tạo simple snowflake texture
          const cvs = document.createElement("canvas");
          cvs.width = 32; // Giảm kích thước
          cvs.height = 32;
          const ctx = cvs.getContext("2d");
          ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
          ctx.beginPath();
          for (let i = 0; i < 6; i++) {
            const angle = (Math.PI / 3) * i;
            ctx.lineTo(
              16 + Math.cos(angle) * 12,
              16 + Math.sin(angle) * 12
            );
          }
          ctx.closePath();
          ctx.fill();
          
          textureCache["Snowflake"] = new THREE.CanvasTexture(cvs);
          
          // Simple circle texture
          const circleCvs = document.createElement("canvas");
          circleCvs.width = 32;
          circleCvs.height = 32;
          const circleCtx = circleCvs.getContext("2d");
          const g = circleCtx.createRadialGradient(16, 16, 0, 16, 16, 15);
          g.addColorStop(0, "rgba(255,255,255,1)");
          g.addColorStop(0.7, "rgba(255,255,255,0.5)");
          g.addColorStop(1, "rgba(255,255,255,0)");
          circleCtx.fillStyle = g;
          circleCtx.fillRect(0, 0, 32, 32);
          textureCache["Circle"] = new THREE.CanvasTexture(circleCvs);
          
          resolve();
        });
      }

      function setupBackgroundParticles() {
        const count = isMobile ? 100 : 800; // Giảm background particles
        bgParticleGroup = new THREE.Group();
        bgParticleGroup.position.z = -12;
        scene.add(bgParticleGroup);
        
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(count * 3);
        for (let i = 0; i < count; i++) {
          starPos[i * 3] = (Math.random() - 0.5) * 120;
          starPos[i * 3 + 1] = (Math.random() - 0.5) * 80;
          starPos[i * 3 + 2] = (Math.random() - 0.5) * 40;
        }
        starGeo.setAttribute("position", new THREE.BufferAttribute(starPos, 3));
        
        bgParticleGroup.add(
          new THREE.Points(
            starGeo,
            new THREE.PointsMaterial({
              color: 0xffeebb,
              size: 0.1,
              transparent: true,
              opacity: 0.6,
            })
          )
        );
      }

      function createPolaroids() {
        polaroidGroup = new THREE.Group();
        const geometry = new THREE.PlaneGeometry(0.7, 0.9); // Giảm kích thước

        const count = TOTAL_PHOTOS;
        const cols = 4; // Giảm số cột
        const radiusBase = 3.5; // Giảm radius

        for (let i = 0; i < count; i++) {
          const material = new THREE.MeshBasicMaterial({
            map: polaroidTextures[i],
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0,
          });
          const polaroid = new THREE.Mesh(geometry, material);
          
          const row = Math.floor(i / cols);
          const col = i % cols;
          const yBase = -1.0 + row * 1.0; // Giảm khoảng cách
          const angleStep = (Math.PI * 1.6) / cols; // Giảm góc
          const angleOffset = row % 2 === 0 ? 0 : angleStep / 2;
          const theta = -2.0 + col * angleStep + angleOffset;
          
          const x = radiusBase * Math.cos(theta);
          const z = radiusBase * Math.sin(theta);
          
          polaroid.userData = {
            targetPos: new THREE.Vector3(x, yBase, z),
            startPos: new THREE.Vector3(x * 3, yBase * 3, z * 3),
            floatOffset: Math.random() * 100,
            targetRot: { 
              y: Math.atan2(x, z) + Math.PI, 
              z: (Math.random() - 0.5) * 0.1 
            },
          };
          
          polaroid.position.copy(polaroid.userData.startPos);
          polaroid.visible = false;
          polaroidGroup.add(polaroid);
        }
        scene.add(polaroidGroup);
      }

      function createLayerSystem(config) {
        const geo = new THREE.BufferGeometry();
        const pos = new Float32Array(config.count * 3);
        const vel = new Float32Array(config.count);
        
        for (let i = 0; i < config.count; i++) {
          const r = config.radius * Math.sqrt(Math.random());
          const theta = Math.random() * 2 * Math.PI;
          const idx = i * 3;
          
          pos[idx] = r * Math.cos(theta);
          pos[idx + 1] = config.startY - Math.random() * (config.startY - config.endY);
          pos[idx + 2] = r * Math.sin(theta);
          
          vel[i] = Math.random() * 0.4 + 0.6;
        }
        
        geo.setAttribute("position", new THREE.BufferAttribute(pos, 3));
        geo.setAttribute("velocity", new THREE.BufferAttribute(vel, 1));
        
        const mat = new THREE.PointsMaterial({
          size: config.size,
          color: new THREE.Color(config.color),
          map: textureCache[config.shape],
          transparent: true,
          opacity: config.opacity,
          blending: THREE.AdditiveBlending,
          depthWrite: false,
          sizeAttenuation: true,
        });
        
        const sys = new THREE.Points(geo, mat);
        sys.userData = { config: config };
        particleSystems[config.id] = sys;
        scene.add(sys);
      }

      // ========== HÀM CHÍNH TỐI ƯU ==========
      function toggleMode() {
        if (isFireworkMode) return;
        const now = clock.getElapsedTime();
        if (now - lastSwitchTime < SWITCH_COOLDOWN) return;
        lastSwitchTime = now;
        isGalleryMode = !isGalleryMode;

        if (!isGalleryMode) {
          document.getElementById("mode-indicator").innerText =
            "SAO MÀ XINH QUÁ VẬY TRỜI";
        }

        if (isGalleryMode) {
          gsap.to(window, {
            duration: 1.0,
            jarOffsetY: -6,
            ease: "power2.inOut",
          });
          
          polaroidGroup.rotation.set(0, 0, 0);
          polaroidGroup.children.forEach((polaroid, index) => {
            polaroid.visible = true;
            polaroid.material.opacity = 0;
            const t = polaroid.userData.targetPos;
            const r = polaroid.userData.targetRot;
            
            gsap.to(polaroid.position, {
              x: t.x,
              y: t.y,
              z: t.z,
              duration: 0.8,
              ease: "power2.out",
              delay: index * 0.02,
            });
            
            gsap.to(polaroid.rotation, {
              x: 0,
              y: r.y,
              z: r.z,
              duration: 0.8,
              ease: "power2.out",
              delay: index * 0.02,
            });
            
            gsap.to(polaroid.material, {
              opacity: 1,
              duration: 0.6,
              delay: index * 0.02,
            });
          });
        } else {
          gsap.to(window, {
            duration: 1.0,
            jarOffsetY: 0,
            ease: "back.out(0.8)",
          });
          
          polaroidGroup.children.forEach((polaroid, index) => {
            const s = polaroid.userData.startPos;
            gsap.to(polaroid.position, {
              x: s.x,
              y: s.y,
              z: s.z,
              duration: 0.6,
              ease: "power2.in",
              delay: index * 0.01,
            });
            
            gsap.to(polaroid.material, {
              opacity: 0,
              duration: 0.5,
              delay: index * 0.01,
            });
          });
        }
      }

      // ========== ANIMATE LOOP TỐI ƯU ==========
      let lastTime = 0;
      const FPS = 60;
      const interval = 1000 / FPS;

      function animate(currentTime = 0) {
        requestAnimationFrame(animate);
        
        // Giới hạn FPS
        const deltaTime = currentTime - lastTime;
        if (deltaTime < interval) return;
        lastTime = currentTime - (deltaTime % interval);

        const dt = clock.getDelta();
        const time = clock.getElapsedTime();

        if (mixer) mixer.update(dt);
        updateLyrics();
        updateParticles(time);
        updatePolaroids(time);
        updateBackgroundParticles(time, dt);

        // Xử lý gesture
        const currentGesture = STATE.hand.gesture;
        if (currentGesture === "VICTORY" && lastGesture !== "VICTORY") {
          toggleMode();
        }
        
        lastGesture = currentGesture;

        // Xoay model
        if (!isTouching && STATE.hand.detected && carModel && !isGalleryMode && inspectedPhoto === null) {
          const targetY = (STATE.hand.x - 0.5) * (Math.PI * 4.0);
          const targetX = (STATE.hand.y - 0.5) * (Math.PI * 0.8);

          STATE.currentRotation.x += (targetX - STATE.currentRotation.x) * 0.08;
          STATE.currentRotation.y += (targetY - STATE.currentRotation.y) * 0.08;

          carModel.rotation.y = STATE.currentRotation.y;
          carModel.rotation.x = STATE.currentRotation.x;
        } else if (carModel && !isGalleryMode && inspectedPhoto === null) {
          carModel.rotation.y += 0.3 * dt;
          carModel.rotation.x *= 0.97;
          STATE.currentRotation.y = carModel.rotation.y;
          STATE.currentRotation.x = carModel.rotation.x;
        }

        // Camera zoom
        if (!isGalleryMode) {
          const targetZ = isZoomedIn ? SCENE_CONFIG.camZNear : SCENE_CONFIG.camZFar;
          camera.position.z += (targetZ - camera.position.z) * SCENE_CONFIG.zoomSpeed;
          
          if (carModel) {
            const targetScale = isZoomedIn ? SCENE_CONFIG.scaleNear : SCENE_CONFIG.scaleFar;
            carModel.scale.setScalar(
              carModel.scale.x + (targetScale - carModel.scale.x) * SCENE_CONFIG.zoomSpeed
            );
          }
        }

        renderer.render(scene, camera);
      }

      function updateParticles(time) {
        if (isFireworkMode) return;
        
        Object.values(particleSystems).forEach((sys) => {
          const cfg = sys.userData.config;
          const positions = sys.geometry.attributes.position.array;
          const velocities = sys.geometry.attributes.velocity.array;
          
          for (let i = 0; i < positions.length / 3; i++) {
            const iy = i * 3 + 1;
            positions[iy] -= velocities[i] * cfg.speed * 8;
            
            if (positions[iy] < cfg.endY) {
              positions[iy] = cfg.startY;
              const r = cfg.radius * Math.sqrt(Math.random());
              const theta = Math.random() * 2 * Math.PI;
              positions[i * 3] = r * Math.cos(theta);
              positions[i * 3 + 2] = r * Math.sin(theta);
            }
          }
          
          sys.geometry.attributes.position.needsUpdate = true;
          
          if (carModel && cfg.rotateWithJar && inspectedPhoto === null && !isTouching) {
            sys.rotation.y = carModel.rotation.y;
            sys.rotation.x = carModel.rotation.x;
          }
        });
      }

      function updatePolaroids(time) {
        if (isFireworkMode || !polaroidGroup) return;
        
        polaroidGroup.children.forEach((p, i) => {
          if (p === inspectedPhoto || p.material.opacity < 0.5) return;
          if (isGalleryMode) {
            const off = p.userData.floatOffset;
            p.position.y = p.userData.targetPos.y + Math.sin(time * 0.6 + off) * 0.1;
            p.rotation.z = p.userData.targetRot.z + Math.sin(time * 0.5 + off) * 0.05;
          }
        });
        
        if (isGalleryMode && inspectedPhoto === null && carModel) {
          polaroidGroup.rotation.y = carModel.rotation.y * 0.5;
          polaroidGroup.rotation.x = carModel.rotation.x * 0.5;
        }
      }

      function updateBackgroundParticles(time, dt) {
        if (!bgParticleGroup) return;
        bgParticleGroup.rotation.z = Math.sin(time * 0.015) * 0.01;
        bgParticleGroup.rotation.y = Math.sin(time * 0.02) * 0.02;
      }

      function updateLyrics() {
        const audio = document.getElementById("bg-music");
        const lyricBox = document.getElementById("lyrics-text");
        if (!audio || audio.paused) return;
        
        const t = audio.currentTime;
        for (let i = LYRICS_DATA.length - 1; i >= 0; i--) {
          if (t >= LYRICS_DATA[i].time) {
            if (lyricBox.innerText !== LYRICS_DATA[i].text) {
              lyricBox.innerText = LYRICS_DATA[i].text;
            }
            break;
          }
        }
      }

      // ========== HAND TRACKING TỐI ƯU ==========
      function initHandTracking() {
        const video = document.getElementById("input_video");
        const canvas = document.getElementById("webcam-canvas");
        const ctx = canvas.getContext("2d");
        
        const hands = new Hands({
          locateFile: (file) =>
            `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
        });

        hands.setOptions({
          maxNumHands: 1,
          modelComplexity: 0,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5,
        });

        hands.onResults((results) => {
          if (!ctx) return;
          
          canvas.width = 160; // Giảm resolution
          canvas.height = 120;
          
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
          
          STATE.hand.gesture = "NONE";
          if (results.multiHandLandmarks.length > 0) {
            STATE.hand.detected = true;
            const lm = results.multiHandLandmarks[0];
            STATE.hand.x = 1 - lm[0].x;
            STATE.hand.y = lm[0].y;
            
            // Simple gesture detection
            const tip8 = lm[8];
            const tip12 = lm[12];
            const tip16 = lm[16];
            const tip20 = lm[20];
            const wrist = lm[0];
            
            const dist8 = Math.hypot(tip8.x - wrist.x, tip8.y - wrist.y);
            const dist12 = Math.hypot(tip12.x - wrist.x, tip12.y - wrist.y);
            const dist16 = Math.hypot(tip16.x - wrist.x, tip16.y - wrist.y);
            const dist20 = Math.hypot(tip20.x - wrist.x, tip20.y - wrist.y);
            
            const avgDist = (dist8 + dist12 + dist16 + dist20) / 4;
            
            if (avgDist < 0.2) {
              STATE.hand.gesture = "FIST";
            } else if (Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05) {
              STATE.hand.gesture = "PINCH";
            } else if (dist8 > 0.3 && dist12 > 0.3 && dist16 < 0.2 && dist20 < 0.2) {
              STATE.hand.gesture = "VICTORY";
            } else {
              STATE.hand.gesture = "OPEN";
            }
          } else {
            STATE.hand.detected = false;
          }
        });

        let frameCounter = 0;
        const cameraUtils = new Camera(video, {
          onFrame: async () => {
            frameCounter++;
            if (frameCounter % AI_SKIP_FRAMES === 0) {
              try {
                await hands.send({ image: video });
              } catch (e) {
                console.log("Hand tracking skipped frame");
              }
            }
          },
          width: 160,
          height: 120,
        });
        cameraUtils.start();
      }

      // ========== KHỞI CHẠY ==========
      window.addEventListener("load", init, { once: true });
    </script>
  </body>
</html>
