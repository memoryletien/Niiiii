<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ni Chủ Tọa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Pinyon+Script&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        overflow: hidden;
        background-color: #0f0505;
        font-family: "Cinzel", serif;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        width: 100vw;
        height: 100vh;
        position: fixed;
      }

      #background-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -3;
        background: #0f0505;
      }

      .bg-loaded {
        background-image: url("./back.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.8;
      }

      #bg-gradient {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        background: radial-gradient(
          circle at 50% 40%,
          rgba(123, 13, 30, 0.5) 0%,
          rgba(74, 14, 22, 0.4) 50%,
          rgba(26, 5, 5, 0.6) 100%
        );
      }

      #black-void {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 5;
        opacity: 0;
        pointer-events: none;
        transition: opacity 1.5s ease;
      }

      #canvas-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
      }

      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 10vh;
      }

      #main-title {
        font-family: "Pinyon Script", cursive;
        font-size: 15vw;
        color: #eebb66;
        margin: 0;
        text-shadow: 0 2px 5px rgba(255, 215, 0, 0.3);
        animation: floatTitle 4s ease-in-out infinite;
        background: linear-gradient(
          to bottom,
          #fceabb 0%,
          #fccd4d 50%,
          #f8b500 51%,
          #fbdf93 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        line-height: 1.2;
      }

      #mode-indicator {
        font-family: "Cinzel", serif;
        font-size: 3vw;
        font-weight: 700;
        color: #ffd700;
        letter-spacing: 4px;
        text-transform: uppercase;
        margin-top: 10px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        padding-bottom: 5px;
      }

      #start-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 5, 5, 0.95);
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .start-btn {
        border: 1px solid #eebb66;
        padding: 15px 30px;
        color: #eebb66;
        font-size: 14px;
        font-family: "Cinzel", serif;
        letter-spacing: 4px;
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.6);
        margin-bottom: 15px;
        box-shadow: 0 0 20px rgba(238, 187, 102, 0.2);
      }
      .start-note {
        color: #886666;
        font-size: 12px;
        font-style: italic;
      }

      #webcam-wrapper {
        position: absolute;
        bottom: 15px;
        left: 15px;
        width: 80px;
        height: 60px;
        z-index: 50;
        background: #000;
        border: 1px solid #ffd700;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        overflow: hidden;
        opacity: 0.6;
        display: none;
      }
      #webcam-canvas {
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
      }

      @keyframes floatTitle {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      @media (min-width: 768px) {
        #main-title {
          font-size: 80px;
        }
        #mode-indicator {
          font-size: 9px;
        }
        #webcam-wrapper {
          width: 120px;
          height: 90px;
        }
      }
    </style>
    <!-- Chỉ load Three.js cơ bản -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body>
    <div id="background-image"></div>
    <div id="black-void"></div>
    <div id="bg-gradient"></div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
      <h1 id="main-title">Ni là số 1</h1>
      <div id="mode-indicator">SAO MÀ XINH QUÁ VẬY TRỜI</div>
    </div>
    <div id="start-overlay">
      <div class="start-btn">NHẤN NÈ NI</div>
      <div class="start-note">♫ Thiên thượng thiên hạ</div>
    </div>

    <div id="webcam-wrapper">
      <canvas id="webcam-canvas"></canvas>
    </div>

    <audio id="bg-music" src="./audio.mp3" loop preload="none"></audio>

    <script>
      // ========== CẤU HÌNH TỐI ƯU CAO ==========
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      // CẤU HÌNH ĐƠN GIẢN - TỐI ƯU TỐC ĐỘ
      const CONFIG = {
        // Giảm tối đa cho mobile
        totalPhotos: isMobile ? 4 : 8,
        particles: isMobile ? 300 : 800,
        showCamera: false, // TẮT CAMERA để tăng performance
        enableMusic: true,
        enableHandTracking: false, // TẮT HAND TRACKING
      };

      // ========== KHỞI TẠO NHANH ==========
      let scene, camera, renderer, jarModel;
      let clock = new THREE.Clock();
      let isInitialized = false;
      let isRotating = true;
      let rotationSpeed = 0.005;

      // Tải background image trước
      function preloadBackground() {
        return new Promise((resolve) => {
          if (!CONFIG.enableMusic) {
            resolve();
            return;
          }
          
          const bg = document.getElementById('background-image');
          const img = new Image();
          img.onload = function() {
            bg.classList.add('bg-loaded');
            resolve();
          };
          img.onerror = resolve;
          img.src = './back.png';
        });
      }

      // Khởi tạo cực nhanh
      async function initQuick() {
        const overlay = document.getElementById("start-overlay");
        
        // Tải background song song
        preloadBackground();
        
        overlay.addEventListener("click", () => {
          overlay.style.opacity = '0';
          setTimeout(() => {
            overlay.style.display = 'none';
            init3DScene();
            if (CONFIG.enableMusic) {
              const audio = document.getElementById("bg-music");
              audio.play().catch(e => console.log("Audio optional"));
            }
          }, 300);
        }, { once: true });
      }

      // ========== SCENE 3D ĐƠN GIẢN ==========
      function init3DScene() {
        if (isInitialized) return;
        isInitialized = true;
        
        const container = document.getElementById("canvas-container");
        
        // Scene đơn giản
        scene = new THREE.Scene();
        scene.background = null;
        
        // Camera đơn giản
        camera = new THREE.PerspectiveCamera(
          50,
          container.clientWidth / container.clientHeight,
          0.1,
          1000
        );
        camera.position.z = 15;
        
        // Renderer tối ưu
        renderer = new THREE.WebGLRenderer({
          antialias: false,
          alpha: true,
          powerPreference: "high-performance",
          preserveDrawingBuffer: false,
          depth: true,
          stencil: false
        });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(1); // LUÔN để 1 cho performance
        renderer.outputEncoding = THREE.sRGBEncoding;
        
        container.appendChild(renderer.domElement);
        
        // Ánh sáng đơn giản
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);
        
        // Tạo jar đơn giản (hình học cơ bản)
        createSimpleJar();
        
        // Tạo particles đơn giản
        createSimpleParticles();
        
        // Tạo photos đơn giản
        createSimplePhotos();
        
        // Bắt đầu animation
        animate();
        
        // Xử lý resize
        window.addEventListener('resize', onWindowResize, { passive: true });
        
        // Bật xoay tự động
        setTimeout(() => {
          isRotating = true;
        }, 1000);
      }

      function createSimpleJar() {
        // Tạo jar từ hình học cơ bản (không cần load GLTF)
        const group = new THREE.Group();
        
        // Thân jar (hình trụ)
        const cylinderGeometry = new THREE.CylinderGeometry(3, 2.5, 6, 16, 1);
        const cylinderMaterial = new THREE.MeshLambertMaterial({ 
          color: 0x8B4513,
          transparent: true,
          opacity: 0.7
        });
        const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
        cylinder.position.y = 0;
        group.add(cylinder);
        
        // Nắp jar
        const lidGeometry = new THREE.CylinderGeometry(2.6, 2.6, 0.5, 16);
        const lidMaterial = new THREE.MeshLambertMaterial({ color: 0xA0522D });
        const lid = new THREE.Mesh(lidGeometry, lidMaterial);
        lid.position.y = 3.2;
        group.add(lid);
        
        // Snow bên trong
        const snowGeometry = new THREE.SphereGeometry(2, 16, 16);
        const snowMaterial = new THREE.MeshLambertMaterial({ 
          color: 0xFFFFFF,
          transparent: true,
          opacity: 0.3
        });
        const snow = new THREE.Mesh(snowGeometry, snowMaterial);
        snow.position.y = -1;
        group.add(snow);
        
        scene.add(group);
        jarModel = group;
      }

      function createSimpleParticles() {
        const particleCount = CONFIG.particles;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);
        
        for (let i = 0; i < particleCount; i++) {
          const i3 = i * 3;
          
          // Vị trí ngẫu nhiên trong jar
          const radius = 2 * Math.sqrt(Math.random());
          const theta = Math.random() * Math.PI * 2;
          const y = (Math.random() - 0.5) * 4;
          
          positions[i3] = radius * Math.cos(theta);
          positions[i3 + 1] = y;
          positions[i3 + 2] = radius * Math.sin(theta);
          
          // Màu sắc (vàng hoặc trắng)
          const isGold = Math.random() > 0.7;
          colors[i3] = isGold ? 1.0 : 0.9;     // R
          colors[i3 + 1] = isGold ? 0.8 : 0.95; // G
          colors[i3 + 2] = isGold ? 0.0 : 1.0;  // B
        }
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        
        const material = new THREE.PointsMaterial({
          size: 0.1,
          vertexColors: true,
          transparent: true,
          opacity: 0.8,
          sizeAttenuation: true
        });
        
        const particles = new THREE.Points(geometry, material);
        particles.position.y = -1;
        scene.add(particles);
        
        // Lưu reference để animation
        scene.userData.particles = particles;
        scene.userData.particlePositions = positions;
      }

      function createSimplePhotos() {
        const photoGroup = new THREE.Group();
        const photoCount = CONFIG.totalPhotos;
        const radius = 8;
        
        for (let i = 0; i < photoCount; i++) {
          // Tạo plane đơn giản
          const geometry = new THREE.PlaneGeometry(2, 2.5);
          const material = new THREE.MeshBasicMaterial({
            color: 0xFFFFFF,
            side: THREE.DoubleSide,
            transparent: true,
            opacity: 0
          });
          
          const photo = new THREE.Mesh(geometry, material);
          
          // Tính vị trí vòng tròn
          const angle = (i / photoCount) * Math.PI * 2;
          const x = Math.cos(angle) * radius;
          const z = Math.sin(angle) * radius;
          const y = Math.sin(angle * 2) * 1.5;
          
          photo.position.set(x, y, z);
          photo.lookAt(0, 0, 0);
          
          // Tải ảnh bất đồng bộ
          loadPhotoTexture(i + 1, material);
          
          photoGroup.add(photo);
        }
        
        scene.add(photoGroup);
        scene.userData.photoGroup = photoGroup;
        scene.userData.photos = photoGroup.children;
      }

      async function loadPhotoTexture(index, material) {
        try {
          const img = new Image();
          img.crossOrigin = "anonymous";
          
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = `./images/${index}.png?t=${Date.now()}`;
          });
          
          // Tạo texture từ ảnh
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const size = isMobile ? 100 : 150;
          canvas.width = size;
          canvas.height = size * 1.25;
          
          // Vẽ ảnh với tỉ lệ đúng
          const imgRatio = img.width / img.height;
          const canvasRatio = canvas.width / canvas.height;
          
          let drawWidth, drawHeight, drawX, drawY;
          
          if (imgRatio > canvasRatio) {
            drawWidth = canvas.width;
            drawHeight = canvas.width / imgRatio;
            drawX = 0;
            drawY = (canvas.height - drawHeight) / 2;
          } else {
            drawHeight = canvas.height;
            drawWidth = canvas.height * imgRatio;
            drawX = (canvas.width - drawWidth) / 2;
            drawY = 0;
          }
          
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
          
          // Tạo texture
          const texture = new THREE.CanvasTexture(canvas);
          texture.minFilter = THREE.LinearFilter;
          texture.magFilter = THREE.LinearFilter;
          
          material.map = texture;
          material.needsUpdate = true;
          
        } catch (error) {
          console.log(`Could not load photo ${index}`);
          // Sử dụng màu mặc định
          material.color.setHex(0xF0F0F0);
        }
      }

      // ========== ANIMATION LOOP TỐI ƯU ==========
      let lastTime = 0;
      let frameCount = 0;
      const targetFPS = 60;
      const frameTime = 1000 / targetFPS;

      function animate(currentTime = 0) {
        requestAnimationFrame(animate);
        
        // Giới hạn FPS
        const deltaTime = currentTime - lastTime;
        if (deltaTime < frameTime) return;
        lastTime = currentTime - (deltaTime % frameTime);
        frameCount++;
        
        const elapsedTime = clock.getElapsedTime();
        
        // Xoay jar nếu đang bật
        if (jarModel && isRotating) {
          jarModel.rotation.y += rotationSpeed;
        }
        
        // Animation particles
        if (scene.userData.particles && scene.userData.particlePositions) {
          const positions = scene.userData.particlePositions;
          for (let i = 0; i < positions.length / 3; i++) {
            const i3 = i * 3 + 1;
            positions[i3] += Math.sin(elapsedTime + i) * 0.005;
            
            // Reset nếu ra ngoài
            if (positions[i3] > 2 || positions[i3] < -4) {
              positions[i3] = (Math.random() - 0.5) * 4;
            }
          }
          scene.userData.particles.geometry.attributes.position.needsUpdate = true;
        }
        
        // Animation photos
        if (scene.userData.photos) {
          scene.userData.photos.forEach((photo, i) => {
            if (photo.material.opacity < 1) {
              photo.material.opacity += 0.01;
            }
            
            // Hiệu ứng float nhẹ
            const floatOffset = Math.sin(elapsedTime * 0.5 + i) * 0.2;
            photo.position.y = Math.sin((i / CONFIG.totalPhotos) * Math.PI * 2 + elapsedTime * 0.3) * 1.5 + floatOffset;
            
            // Quay về camera
            photo.lookAt(camera.position);
          });
        }
        
        // Render
        renderer.render(scene, camera);
      }

      function onWindowResize() {
        if (!camera || !renderer) return;
        
        const container = document.getElementById("canvas-container");
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      }

      // ========== TOUCH CONTROLS ĐƠN GIẢN ==========
      function initTouchControls() {
        const container = document.getElementById("canvas-container");
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;
        
        container.addEventListener('touchstart', (e) => {
          if (e.touches.length === 1) {
            isDragging = true;
            isRotating = false;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
            e.preventDefault();
          }
        }, { passive: false });
        
        container.addEventListener('touchmove', (e) => {
          if (!isDragging || e.touches.length !== 1) return;
          
          const currentX = e.touches[0].clientX;
          const currentY = e.touches[0].clientY;
          
          const deltaX = currentX - lastX;
          const deltaY = currentY - lastY;
          
          if (jarModel) {
            jarModel.rotation.y += deltaX * 0.01;
            jarModel.rotation.x += deltaY * 0.005;
          }
          
          lastX = currentX;
          lastY = currentY;
          e.preventDefault();
        }, { passive: false });
        
        container.addEventListener('touchend', () => {
          isDragging = false;
          // Bật lại auto rotate sau 2 giây không touch
          setTimeout(() => {
            if (!isDragging) {
              isRotating = true;
            }
          }, 2000);
        });
        
        // Double tap để toggle photos
        let lastTap = 0;
        container.addEventListener('touchend', (e) => {
          const currentTime = Date.now();
          const tapLength = currentTime - lastTap;
          
          if (tapLength < 300 && tapLength > 0) {
            togglePhotos();
          }
          lastTap = currentTime;
        });
      }

      function togglePhotos() {
        if (!scene.userData.photoGroup) return;
        
        const photos = scene.userData.photos;
        const isVisible = photos[0].material.opacity > 0.5;
        
        if (isVisible) {
          // Ẩn photos
          photos.forEach(photo => {
            gsap.to(photo.material, {
              opacity: 0,
              duration: 0.5,
              ease: "power2.in"
            });
          });
        } else {
          // Hiện photos
          photos.forEach((photo, i) => {
            gsap.to(photo.material, {
              opacity: 1,
              duration: 0.8,
              delay: i * 0.05,
              ease: "power2.out"
            });
          });
        }
      }

      // ========== TẢI GSAP LAZY ==========
      function loadGSAP() {
        return new Promise((resolve) => {
          if (window.gsap) {
            resolve();
            return;
          }
          
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js';
          script.onload = resolve;
          script.onerror = resolve; // Không block nếu không tải được
          document.head.appendChild(script);
        });
      }

      // ========== KHỞI ĐỘNG ==========
      window.addEventListener('DOMContentLoaded', async () => {
        // Khởi động nhanh
        initQuick();
        
        // Tải GSAP sau (lazy load)
        setTimeout(loadGSAP, 1000);
        
        // Khởi tạo touch controls
        initTouchControls();
      });

      // ========== CLEANUP ==========
      window.addEventListener('beforeunload', () => {
        // Dọn dẹp memory
        if (scene) {
          scene.traverse((object) => {
            if (object.geometry) object.geometry.dispose();
            if (object.material) {
              if (object.material.map) object.material.map.dispose();
              object.material.dispose();
            }
          });
        }
        
        if (renderer) {
          renderer.dispose();
          renderer.forceContextLoss();
        }
      });
    </script>
  </body>
</html>
